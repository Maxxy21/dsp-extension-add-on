!function(){"use strict";const e={serviceTypes:{cycle1:!0,samedayB:!1,samedayC:!1},notificationsEnabled:!0,webhooks:{},schedulingBaseUrl:"",serviceAreaId:""},t="manualCheck",s="sendMessage",n="getSettings",a={WEBHOOKS:"webhooks",NOTIFICATIONS_ENABLED:"notificationsEnabled",SERVICE_TYPES:"serviceTypes",SCHEDULING_BASE_URL:"schedulingBaseUrl",SERVICE_AREA_ID:"serviceAreaId",MANIFEST_DATA:"manifestData",BACKBRIEF_DATA:"backbriefData",TEMP_MANIFEST_MAP:"tempManifestMap"},i="NETWORK_ERROR",r="VALIDATION_ERROR";const o=new class{constructor(){this.storage=browser.storage.local,this.cache=new Map,this.cacheExpiry=new Map,this.cacheTTL=3e5}async get(e,t=null){try{if(this.isCacheValid(e))return this.cache.get(e);const s=await this.storage.get(e),n=void 0!==s[e]?s[e]:t;return this.setCache(e,n),n}catch(s){return console.error(`Storage get error for key "${e}":`,s),t}}async getMultiple(e){try{const t=await this.storage.get(e);return e.forEach(e=>{void 0!==t[e]&&this.setCache(e,t[e])}),t}catch(e){return console.error("Storage getMultiple error:",e),{}}}async set(e,t){try{return await this.storage.set({[e]:t}),this.setCache(e,t),!0}catch(t){return console.error(`Storage set error for key "${e}":`,t),!1}}async setMultiple(e){try{return await this.storage.set(e),Object.entries(e).forEach(([e,t])=>{this.setCache(e,t)}),!0}catch(e){return console.error("Storage setMultiple error:",e),!1}}async remove(e){try{return await this.storage.remove(e),this.cache.delete(e),this.cacheExpiry.delete(e),!0}catch(t){return console.error(`Storage remove error for key "${e}":`,t),!1}}async clear(){try{return await this.storage.clear(),this.cache.clear(),this.cacheExpiry.clear(),!0}catch(e){return console.error("Storage clear error:",e),!1}}async getAll(){try{return await this.storage.get(null)}catch(e){return console.error("Storage getAll error:",e),{}}}getWebhooks(){return this.get(a.WEBHOOKS,{})}setWebhooks(e){return this.set(a.WEBHOOKS,e)}getNotificationsEnabled(){return this.get(a.NOTIFICATIONS_ENABLED,e.notificationsEnabled)}setNotificationsEnabled(e){return this.set(a.NOTIFICATIONS_ENABLED,e)}getServiceTypes(){return this.get(a.SERVICE_TYPES,e.serviceTypes)}setServiceTypes(e){return this.set(a.SERVICE_TYPES,e)}getSchedulingBaseUrl(){return this.get(a.SCHEDULING_BASE_URL,e.schedulingBaseUrl)}setSchedulingBaseUrl(e){return this.set(a.SCHEDULING_BASE_URL,e)}getServiceAreaId(){return this.get(a.SERVICE_AREA_ID,e.serviceAreaId)}setServiceAreaId(e){return this.set(a.SERVICE_AREA_ID,e)}setCache(e,t){this.cache.set(e,t),this.cacheExpiry.set(e,Date.now()+this.cacheTTL)}isCacheValid(e){return!(!this.cache.has(e)||!this.cacheExpiry.has(e))&&Date.now()<this.cacheExpiry.get(e)}clearExpiredCache(){const e=Date.now();for(const[t,s]of this.cacheExpiry.entries())e>=s&&(this.cache.delete(t),this.cacheExpiry.delete(t))}async initialize(){try{const t=await this.getAll(),s={};Object.entries(e).forEach(([e,n])=>{const i=a[e.toUpperCase()]||e;void 0===t[i]&&(s[i]=n)}),Object.keys(s).length>0&&await this.setMultiple(s),setInterval(()=>this.clearExpiredCache(),this.cacheTTL)}catch(e){console.error("Storage initialization error:",e)}}};function c(e){if(!e||"string"!=typeof e)return!1;return/^[A-Za-z0-9]{3,6}$/.test(e.trim())}class l extends Error{constructor(e,t,s={}){super(e),this.name=this.constructor.name,this.code=t,this.details=s,this.timestamp=(new Date).toISOString(),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}toJSON(){return{name:this.name,message:this.message,code:this.code,details:this.details,timestamp:this.timestamp,stack:this.stack}}getUserMessage(){return this.details.userMessage||this.message}}class d extends l{constructor(e,t={}){super(e,i,t)}static fromFetchError(e,t){return new d(`Network request failed for URL: ${e}`,{url:e,originalError:t?.message,userMessage:"Network connection failed. Please check your internet connection and try again."})}static fromWebhookError(e,t,s){return new d(`Webhook request failed: ${t}`,{webhookUrl:e,statusCode:t,originalError:s?.message,userMessage:"Failed to send notification. Please check your webhook configuration."})}}class h extends l{constructor(e,t={}){super(e,r,t)}static fromFieldValidation(e,t,s){return new h(`Validation failed for field "${e}"`,{field:e,value:t,rule:s,userMessage:`Invalid ${e}. Please check the format and try again.`})}static fromMultipleFields(e){const t=e.map(e=>e.field).join(", ");return new h(`Validation failed for fields: ${t}`,{fieldErrors:e,userMessage:"Please correct the highlighted fields and try again."})}}class u{static logError(e,t=""){const s={context:t,timestamp:(new Date).toISOString(),error:e instanceof l?e.toJSON():{name:e.name,message:e.message,stack:e.stack}};console.error("Extension Error:",s),"undefined"!=typeof window&&window.gtag&&window.gtag("event","exception",{description:e.message,fatal:!1})}static notifyUser(e,t="An unexpected error occurred"){const s=e instanceof l?e.getUserMessage():t;browser?.notifications?.create&&browser.notifications.create({type:"basic",iconUrl:"icons/icon.svg",title:"DSP Extension Error",message:s}).catch(console.error),console.warn("User notification:",s)}static async handleAsyncError(e,t=""){try{return await e}catch(e){throw this.logError(e,t),e}}static createErrorBoundary(e,t=""){return async(...s)=>{try{return await e(...s)}catch(e){throw this.logError(e,t),this.notifyUser(e),e}}}}function m(e,t=""){return u.createErrorBoundary(e,t)}class g{constructor(e){this.messageService=e,this.availableDSPs={},this.selectedDSPs=new Set,this.selectionMode="individual",this.elements={dspSelect:null,checkboxContainer:null,totalDspCount:null,individualGroup:null,multipleGroup:null,allGroup:null}}initialize(e){this.elements={...this.elements,...e},this.setupEventListeners(),this.loadAvailableDSPs()}setupEventListeners(){["individual","multiple","all"].forEach(e=>{const t=document.querySelector(`input[name="targetType"][value="${e}"]`);t&&t.addEventListener("change",m(()=>this.handleSelectionModeChange(e),"DSPManager.handleSelectionModeChange"))}),this.elements.dspSelect&&this.elements.dspSelect.addEventListener("change",m(this.handleIndividualSelection.bind(this),"DSPManager.handleIndividualSelection")),this.elements.checkboxContainer&&this.elements.checkboxContainer.addEventListener("change",m(this.handleMultipleSelection.bind(this),"DSPManager.handleMultipleSelection"))}async loadAvailableDSPs(){try{const e=await o.getWebhooks();this.availableDSPs=e||{},this.updateDSPOptions(),this.updateDSPCheckboxes(),this.updateDSPCount(),Object.keys(this.availableDSPs).length}catch(e){console.error("Failed to load DSPs:",e),this.showError("Failed to load DSP list")}}updateDSPOptions(){if(!this.elements.dspSelect)return;for(;this.elements.dspSelect.firstChild;)this.elements.dspSelect.removeChild(this.elements.dspSelect.firstChild);const e=document.createElement("option");e.value="",e.textContent="Select DSP...",this.elements.dspSelect.appendChild(e);const t=Object.keys(this.availableDSPs).sort();for(const e of t){const t=document.createElement("option");t.value=e,t.textContent=e,this.elements.dspSelect.appendChild(t)}this.elements.dspSelect.disabled=0===t.length}updateDSPCheckboxes(){if(!this.elements.checkboxContainer)return;this.elements.checkboxContainer.textContent="";const e=Object.keys(this.availableDSPs).sort();if(0===e.length){const e=document.createElement("p");return e.className="no-dsps",e.textContent="No DSPs configured",void this.elements.checkboxContainer.appendChild(e)}for(const t of e){const e=document.createElement("div");e.className="checkbox-wrapper";const s=document.createElement("input");s.type="checkbox",s.id=`dsp_${t}`,s.value=t,s.className="dsp-checkbox";const n=document.createElement("label");n.htmlFor=`dsp_${t}`,n.textContent=t,n.className="dsp-label",e.appendChild(s),e.appendChild(n),this.elements.checkboxContainer.appendChild(e)}this.addSelectAllControls()}addSelectAllControls(){if(!this.elements.checkboxContainer)return;const e=document.createElement("div");e.className="selection-controls";const t=document.createElement("button");t.type="button",t.textContent="Select All",t.className="btn btn-small",t.addEventListener("click",()=>this.selectAllDSPs(!0));const s=document.createElement("button");s.type="button",s.textContent="Select None",s.className="btn btn-small",s.addEventListener("click",()=>this.selectAllDSPs(!1)),e.appendChild(t),e.appendChild(s),this.elements.checkboxContainer.appendChild(e)}handleSelectionModeChange(e){this.selectionMode=e,this.selectedDSPs.clear(),this.updateGroupVisibility(),this.clearSelections()}updateGroupVisibility(){const e={individual:this.elements.individualGroup,multiple:this.elements.multipleGroup,all:this.elements.allGroup};Object.entries(e).forEach(([e,t])=>{t&&(t.style.display=e===this.selectionMode?"block":"none")})}handleIndividualSelection(e){const t=e.target.value;this.selectedDSPs.clear(),t&&c(t)&&this.selectedDSPs.add(t),this.updateSendButtonText()}handleMultipleSelection(e){if(!e.target.classList.contains("dsp-checkbox"))return;const t=e.target.value;e.target.checked?this.selectedDSPs.add(t):this.selectedDSPs.delete(t),Array.from(this.selectedDSPs).join(", "),this.updateSendButtonText()}selectAllDSPs(e){const t=this.elements.checkboxContainer?.querySelectorAll(".dsp-checkbox")||[];this.selectedDSPs.clear(),t.forEach(t=>{t.checked=e,e&&this.selectedDSPs.add(t.value)}),this.updateSendButtonText()}clearSelections(){this.selectedDSPs.clear(),this.elements.dspSelect&&(this.elements.dspSelect.value="");(this.elements.checkboxContainer?.querySelectorAll(".dsp-checkbox")||[]).forEach(e=>{e.checked=!1}),this.updateSendButtonText()}updateDSPCount(){if(!this.elements.totalDspCount)return;const e=Object.keys(this.availableDSPs).length;this.elements.totalDspCount.textContent=e}updateSendButtonText(){const e=document.getElementById("sendButtonText");if(!e)return;let t="Send Message";switch(this.selectionMode){case"individual":1===this.selectedDSPs.size&&(t=`Send to ${Array.from(this.selectedDSPs)[0]}`);break;case"multiple":this.selectedDSPs.size>0&&(t=`Send to ${this.selectedDSPs.size} DSPs`);break;case"all":t=`Send to All (${Object.keys(this.availableDSPs).length} DSPs)`;break}e.textContent=t}getSelectedDSPs(){switch(this.selectionMode){case"individual":case"multiple":return Array.from(this.selectedDSPs);case"all":return Object.keys(this.availableDSPs);default:return[]}}getSelectionInfo(){const e=this.getSelectedDSPs();return{mode:this.selectionMode,dsps:e,count:e.length,isValid:e.length>0}}validateSelection(){const e=this.getSelectedDSPs();if(0===e.length)return{isValid:!1,error:"No DSPs selected"};const t=e.filter(e=>!c(e));return t.length>0?{isValid:!1,error:`Invalid DSP codes: ${t.join(", ")}`}:{isValid:!0,dsps:e}}async refresh(){await this.loadAvailableDSPs(),this.clearSelections()}showError(e){console.error("DSP Manager Error:",e);const t=document.getElementById("status");t&&(t.textContent=e,t.className="toast error show",setTimeout(()=>{t.className="toast"},3e3))}getStatistics(){return{totalDSPs:Object.keys(this.availableDSPs).length,selectedCount:this.selectedDSPs.size,selectionMode:this.selectionMode,hasValidSelection:this.validateSelection().isValid}}}class p{constructor(e,t){this.messageService=e,this.dspManager=t,this.isProcessing=!1}async sendSummary(e={}){if(this.isProcessing)throw new Error("Summary sending already in progress");try{this.isProcessing=!0;const t=this.dspManager.getSelectionInfo();if(!t.isValid)throw new h("No DSPs selected for summary");const s=await this.collectSummaryData(t.dsps,e),n=this.generateSummaryMessages(s,e),a=await this.sendSummaryMessages(n,t);return a.successful.length,{success:!0,results:a,summaryData:s,timestamp:(new Date).toISOString()}}catch(e){throw console.error("Summary sending failed:",e),e}finally{this.isProcessing=!1}}async collectSummaryData(e,t={}){try{const s=await this.findRoutePlanningTab();return s?await this.extractFromExistingTab(s,e,t):await this.extractFromNewTab(e,t)}catch(t){throw new d("Failed to collect summary data",{originalError:t.message,targetDSPs:e})}}async findRoutePlanningTab(){try{const e=await browser.tabs.query({url:"*://*.route.planning.last-mile.a2z.com/route-planning/*"});return e.length>0?e[0]:null}catch(e){return console.warn("Failed to query tabs:",e),null}}async extractFromExistingTab(e,t,s){let n=s.paidTimeMinutes||525;if(s.collectPaidTime)try{n=await this.collectPaidTimeFromConstraints()}catch(e){console.warn("Failed to collect paid time, using default:",e)}const a=await browser.tabs.sendMessage(e.id,{action:"getSummaryData",targetDSPs:t,paidTimeMinutes:n});if(!a||!a.success)throw new Error(`Failed to extract data: ${a?.error||"Unknown error"}`);return{data:a.data,paidTimeMinutes:n,source:"existing_tab",tabId:e.id}}async extractFromNewTab(e,t){const s=await this.getSettings(),n=s.routePlanningBaseUrl||"https://eu.route.planning.last-mile.a2z.com/route-planning",a=function(e){const t=new Date,s=new Date(t);return"cycle1"===e&&s.setDate(s.getDate()+1),`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`}("other"),i=this.buildRoutePlanningURL(n,a,s),r=await browser.tabs.create({url:i,active:!1});try{return await this.waitForTabLoad(r.id),await this.extractFromExistingTab(r,e,t)}finally{try{await browser.tabs.remove(r.id)}catch(e){console.warn("Failed to close tab:",e)}}}buildRoutePlanningURL(e,t,s){try{const n=new URL(e);return n.searchParams.set("date",t),s.serviceAreaId&&n.searchParams.set("serviceAreaId",s.serviceAreaId),n.toString()}catch(t){return console.warn("Failed to build URL, using base:",t),e}}waitForTabLoad(e){return new Promise((t,s)=>{const n=setTimeout(()=>{s(new Error("Tab load timeout"))},3e4),a=async()=>{try{"complete"===(await browser.tabs.get(e)).status?(clearTimeout(n),t()):setTimeout(a,1e3)}catch(e){clearTimeout(n),s(e)}};a()})}async collectPaidTimeFromConstraints(){try{const e=await this.getSettings(),{constraintsUrl:t}=e;if(!t)throw new Error("No constraints URL configured");const s=await browser.tabs.query({url:"*://eu.dispatch.planning.last-mile.a2z.com/route-constraints/*"});if(s.length>0){const e=await browser.tabs.sendMessage(s[0].id,{action:"getPaidTimeFromConstraints"});if(e&&e.success&&e.paidTime)return e.paidTime}throw new Error("Could not collect paid time from constraints")}catch(e){return console.warn("Failed to collect paid time:",e),525}}generateSummaryMessages(e,t={}){const s=[],n=e.data||{},a=e.paidTimeMinutes||525,i=this.formatDateForDisplay(new Date);for(const[e,r]of Object.entries(n)){if(!r)continue;const n=this.createSummaryMessage(e,r,a,i,t);s.push({dsp:e,message:n,data:r})}return s}createSummaryMessage(e,t,s,n,a={}){const{routeCount:i=0,stopCount:r=0,packageCount:o=0,utilization:c={}}=t;return[`ðŸ“Š Daily Summary for ${e} - ${n}`,"",`ðŸšš Routes: ${i}`,`ðŸ“ Stops: ${r}`,`ðŸ“¦ Packages: ${o}`,`â±ï¸ Paid Time: ${Math.round(s/60*10)/10}h`,"","ðŸ“ˆ Performance:",`â€¢ Avg stops/route: ${c.avgStopsPerRoute||0}`,`â€¢ Stops/hour: ${c.stopsPerHour||0}`,`â€¢ Route utilization: ${c.routeUtilization||0}%`,"","Generated by DSP Management Extension"].join("\n")}async sendSummaryMessages(e,t){e.length;const n={successful:[],failed:[],totalSent:0,totalFailed:0};for(const t of e)try{const e=await browser.runtime.sendMessage({action:s,dsp:t.dsp,message:t.message,targetType:"individual"});e&&e.success?(n.successful.push(t.dsp),n.totalSent++):(n.failed.push({dsp:t.dsp,error:e?.error||"Unknown error"}),n.totalFailed++)}catch(e){n.failed.push({dsp:t.dsp,error:e.message}),n.totalFailed++}return n}async sendFailedReattemptsReport(e={}){try{const e=await browser.runtime.sendMessage({action:"previewFailedReattemptStats"});if(!e||!e.success)throw new Error("Failed to get reattempts preview");const t=await browser.runtime.sendMessage({action:"runFailedReattemptReport"});if(!t||!t.success)throw new Error(`Failed to send reattempts report: ${t?.error||"Unknown error"}`);return{success:!0,preview:e,result:t,timestamp:(new Date).toISOString()}}catch(e){throw console.error("Failed reattempts report failed:",e),e}}async getSettings(){try{const e=await browser.runtime.sendMessage({action:n});return e&&e.success&&e.settings||{}}catch(e){return console.warn("Failed to get settings:",e),{}}}formatDateForDisplay(e){return`${String(e.getDate()).padStart(2,"0")}.${String(e.getMonth()+1).padStart(2,"0")}.${e.getFullYear()}`}isProcessingSummary(){return this.isProcessing}getStatistics(){return{isProcessing:this.isProcessing,lastSendTime:this.lastSendTime||null,hasRoutePlanningAccess:this.hasRoutePlanningAccess()}}hasRoutePlanningAccess(){return!0}}class S{constructor(){this.dspManager=null,this.summarySender=null,this.messageService=new y,this.isLoading=!1,this.elements={},this.characterLimit=2e3,this.setupPolyfill(),this.initialize()}setupPolyfill(){"undefined"==typeof browser&&"undefined"!=typeof chrome&&(window.browser=chrome)}async initialize(){try{"loading"===document.readyState&&await new Promise(e=>{document.addEventListener("DOMContentLoaded",e)}),this.cacheElements(),this.initializeManagers(),this.setupEventListeners(),await this.loadInitialData(),this.setupCharacterCounter()}catch(e){u.logError(e,"PopupManager.initialize"),this.showError("Failed to initialize popup")}}cacheElements(){this.elements={dspSelect:document.getElementById("dspSelect"),checkboxContainer:document.getElementById("dspCheckboxes"),totalDspCount:document.getElementById("totalDspCount"),individualGroup:document.getElementById("individualDspGroup"),multipleGroup:document.getElementById("multipleDspGroup"),allGroup:document.getElementById("allDspGroup"),messageInput:document.getElementById("message"),charCount:document.getElementById("charCount"),sendButtonText:document.getElementById("sendButtonText"),checkNowButton:document.getElementById("checkNow"),sendSummaryButton:document.getElementById("sendSummary"),sendReattemptsButton:document.getElementById("sendReattempts"),sendMessageButton:document.getElementById("sendMessage"),openSettingsButton:document.getElementById("openSettings"),connectionStatus:document.getElementById("connectionStatus"),toast:document.getElementById("status")};const e=["dspSelect","messageInput","sendMessageButton"].filter(e=>!this.elements[e]);if(e.length>0)throw new Error(`Missing required elements: ${e.join(", ")}`)}initializeManagers(){this.dspManager=new g(this.messageService),this.summarySender=new p(this.messageService,this.dspManager),this.dspManager.initialize({dspSelect:this.elements.dspSelect,checkboxContainer:this.elements.checkboxContainer,totalDspCount:this.elements.totalDspCount,individualGroup:this.elements.individualGroup,multipleGroup:this.elements.multipleGroup,allGroup:this.elements.allGroup})}setupEventListeners(){this.elements.checkNowButton&&this.elements.checkNowButton.addEventListener("click",m(this.handleManualCheck.bind(this),"PopupManager.handleManualCheck")),this.elements.sendMessageButton.addEventListener("click",m(this.handleSendMessage.bind(this),"PopupManager.handleSendMessage")),this.elements.sendSummaryButton&&this.elements.sendSummaryButton.addEventListener("click",m(this.handleSendSummary.bind(this),"PopupManager.handleSendSummary")),this.elements.sendReattemptsButton&&this.elements.sendReattemptsButton.addEventListener("click",m(this.handleSendReattempts.bind(this),"PopupManager.handleSendReattempts")),this.elements.openSettingsButton&&this.elements.openSettingsButton.addEventListener("click",m(this.handleOpenSettings.bind(this),"PopupManager.handleOpenSettings")),this.elements.messageInput&&this.elements.messageInput.addEventListener("input",m(this.handleMessageInput.bind(this),"PopupManager.handleMessageInput")),document.addEventListener("keydown",m(this.handleKeyboardShortcuts.bind(this),"PopupManager.handleKeyboardShortcuts"))}async loadInitialData(){try{await this.checkConnectionStatus()}catch(e){console.warn("Failed to load initial data:",e),this.showError("Failed to load extension data")}}setupCharacterCounter(){if(!this.elements.messageInput||!this.elements.charCount)return;const e=()=>{const e=this.elements.messageInput.value.length,t=this.characterLimit-e;this.elements.charCount.textContent=`${e}/${this.characterLimit}`,this.elements.charCount.className=t<0?"char-count over-limit":t<100?"char-count near-limit":"char-count"};e(),this.elements.messageInput.addEventListener("input",e)}async handleManualCheck(){if(!this.isLoading)try{this.setLoading(!0),this.showToast("Running manual check...","info");const e=await browser.runtime.sendMessage({action:t});if(!e||!e.success)throw new Error(e?.error||"Manual check failed");{const{summary:t,mismatches:s}=e;s&&s.length>0?this.showToast(`Found ${s.length} mismatches`,"warning"):this.showToast("No mismatches found","success")}}catch(e){u.logError(e,"PopupManager.handleManualCheck"),this.showToast("Manual check failed","error")}finally{this.setLoading(!1)}}async handleSendMessage(){if(!this.isLoading)try{this.setLoading(!0);const e=function(e,t=2e3){const s=[];if(!e||"string"!=typeof e)return s.push("Message is required"),{isValid:!1,errors:s};const n=e.trim();return 0===n.length&&s.push("Message cannot be empty"),n.length>t&&s.push(`Message cannot exceed ${t} characters`),[/<script/i,/javascript:/i,/on\w+\s*=/i].some(e=>e.test(n))&&s.push("Message contains potentially unsafe content"),{isValid:0===s.length,errors:s,cleanMessage:n}}(this.elements.messageInput.value,this.characterLimit);if(!e.isValid)return void this.showToast(e.errors[0],"error");const t=this.dspManager.getSelectionInfo();if(!t.isValid)return void this.showToast("Please select at least one DSP","error");this.showToast(`Sending message to ${t.count} DSP(s)...`,"info");const n=await browser.runtime.sendMessage({action:s,dsp:t.dsps,message:e.cleanMessage,targetType:t.mode});if(!n||!n.success)throw new Error(n?.error||"Failed to send message");{const{result:e}=n;"object"==typeof e&&void 0!==e.totalSent?(this.showToast(`Message sent to ${e.totalSent} DSPs`,"success"),e.totalFailed>0&&console.warn(`${e.totalFailed} messages failed to send`)):this.showToast("Message sent successfully","success"),this.elements.messageInput.value="",this.setupCharacterCounter()}}catch(e){u.logError(e,"PopupManager.handleSendMessage"),this.showToast("Failed to send message","error")}finally{this.setLoading(!1)}}async handleSendSummary(){if(!this.isLoading&&!this.summarySender.isProcessingSummary())try{this.setLoading(!0),this.showToast("Collecting and sending summaries...","info");const e=await this.summarySender.sendSummary({collectPaidTime:!0,includeUtilization:!0});if(!e.success)throw new Error("Summary sending failed");{const{results:t}=e;this.showToast(`Summaries sent to ${t.successful.length} DSPs`,"success"),t.totalFailed>0&&console.warn(`${t.totalFailed} summaries failed to send`)}}catch(e){u.logError(e,"PopupManager.handleSendSummary"),this.showToast("Failed to send summaries","error")}finally{this.setLoading(!1)}}async handleSendReattempts(){if(!this.isLoading)try{this.setLoading(!0),this.showToast("Sending failed reattempts report...","info");if(!(await this.summarySender.sendFailedReattemptsReport()).success)throw new Error("Reattempts report failed");this.showToast("Reattempts report sent successfully","success")}catch(e){u.logError(e,"PopupManager.handleSendReattempts"),this.showToast("Failed to send reattempts report","error")}finally{this.setLoading(!1)}}async handleOpenSettings(){try{if(browser.runtime.openOptionsPage)return void await browser.runtime.openOptionsPage();await this.openOptionsFallback()}catch(e){try{await this.openOptionsFallback()}catch(e){u.logError(e,"PopupManager.handleOpenSettings"),this.showToast("Failed to open settings","error")}}}async openOptionsFallback(){await browser.tabs.create({url:browser.runtime.getURL("options/options.html")})}handleMessageInput(){}handleKeyboardShortcuts(e){if((e.ctrlKey||e.metaKey)&&"Enter"===e.key)return e.preventDefault(),void this.handleSendMessage();"Escape"!==e.key||window.close()}async checkConnectionStatus(){try{const e=await browser.runtime.sendMessage({action:n}),t=e?.settings?.webhooks||{},s=Object.keys(t).length>0,a=Boolean(e?.success&&s);return this.updateConnectionStatus(a),a}catch(e){return this.updateConnectionStatus(!1),!1}}updateConnectionStatus(e){if(!this.elements.connectionStatus)return;this.elements.connectionStatus.className="connection-status "+(e?"connected":"disconnected"),this.elements.connectionStatus.title=e?"Extension ready to send notifications":"Configure webhooks in options to enable notifications";const t=this.elements.connectionStatus.querySelector("span");t&&(t.textContent=e?"Ready":"Setup Required")}setLoading(e){this.isLoading=e;[this.elements.checkNowButton,this.elements.sendMessageButton,this.elements.sendSummaryButton,this.elements.sendReattemptsButton].filter(Boolean).forEach(t=>{t.disabled=e}),document.body.style.cursor=e?"wait":""}showToast(e,t="info"){if(!this.elements.toast)return;this.elements.toast.textContent=e,this.elements.toast.className=`toast ${t} show`;setTimeout(()=>{this.elements.toast.className="toast"},"error"===t||"warning"===t?5e3:3e3)}showError(e){this.showToast(e,"error")}getStatistics(){return{isLoading:this.isLoading,dspStats:this.dspManager?.getStatistics(),summaryStats:this.summarySender?.getStatistics(),messageLength:this.elements.messageInput?.value?.length||0}}}class y{async sendMessage(e){try{return await browser.runtime.sendMessage(e)}catch(e){throw console.error("Message sending failed:",e),e}}async sendToContent(e,t){try{return await browser.tabs.sendMessage(e,t)}catch(e){throw console.error("Content message sending failed:",e),e}}}const w=new S;window.dspPopupManager=w,"undefined"!=typeof module&&module.exports&&(module.exports={PopupManager:S,MessageService:y})}();
